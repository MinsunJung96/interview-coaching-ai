import { NextRequest, NextResponse } from 'next/server';

// 전공별 맞춤 질문 생성 함수
function getMajorSpecificQuestions(major: string): string {
  const questionsByMajor: { [key: string]: string } = {
    // 공학 계열
    '컴퓨터공학부': `- AI와 머신러닝 기술의 발전이 소프트웨어 개발에 미치는 영향에 대해 어떻게 생각하시나요?
- 클라우드 컴퓨팅과 엣지 컴퓨팅의 차이점과 각각의 장단점에 대해 설명해주세요.
- 최근 주목받고 있는 메타버스 기술에 대한 견해를 들려주세요.`,
    
    '전기정보공학부': `- 전기차 배터리 기술의 발전 방향과 한계점에 대해 어떻게 생각하시나요?
- 스마트그리드 기술이 미래 에너지 시스템에 미칠 영향에 대해 설명해주세요.
- IoT 기술과 5G/6G 통신의 연관성에 대해 어떻게 이해하고 계신가요?`,
    
    '기계공학부': `- 로봇공학과 자동화 기술의 미래 전망에 대해 어떻게 생각하시나요?
- 친환경 자동차 기술(전기차, 수소차)에 대한 견해를 들려주세요.
- 3D 프린팅 기술이 제조업에 미치는 변화에 대해 설명해주세요.`,
    
    '화학생물공학부': `- 바이오 연료와 친환경 화학 기술의 발전 방향에 대해 어떻게 생각하시나요?
- 나노 기술의 의학적 응용에 대한 견해를 들려주세요.
- 플라스틱 대체 소재 개발의 중요성에 대해 설명해주세요.`,
    
    // 의학 계열
    '의학과': `- AI 진단 시스템의 발전과 의사의 역할 변화에 대해 어떻게 생각하시나요?
- 개인 맞춤형 의료(Precision Medicine)의 장단점에 대해 설명해주세요.
- 의료 윤리와 기술 발전의 균형에 대한 견해를 들려주세요.`,
    
    '치의학과': `- 디지털 치의학 기술의 발전과 임상 적용에 대해 어떻게 생각하시나요?
- 구강 건강과 전신 건강의 연관성에 대한 견해를 들려주세요.
- 치과 치료의 미래 기술에 대해 설명해주세요.`,
    
    // 경영 계열
    '경영학과': `- ESG 경영의 중요성과 기업의 사회적 책임에 대해 어떻게 생각하시나요?
- 디지털 전환(Digital Transformation)이 경영에 미치는 영향에 대해 설명해주세요.
- 스타트업 생태계와 혁신 경영에 대한 견해를 들려주세요.`,
    
    // 인문 사회 계열
    '정치외교학과': `- 글로벌 거버넌스와 국제 협력의 미래에 대해 어떻게 생각하시나요?
- 디지털 민주주의와 시민 참여에 대한 견해를 들려주세요.
- 기후 변화와 국제 정치의 연관성에 대해 설명해주세요.`,
    
    '경제학과': `- 암호화폐와 블록체인 기술이 경제에 미치는 영향에 대해 어떻게 생각하시나요?
- 포용적 성장과 경제 불평등 해소 방안에 대한 견해를 들려주세요.
- 디지털 경제와 플랫폼 비즈니스의 미래에 대해 설명해주세요.`,
    
    '심리학과': `- AI와 심리학의 융합에 대한 견해를 들려주세요.
- 디지털 시대의 정신 건강과 소셜미디어의 영향에 대해 어떻게 생각하시나요?
- 긍정심리학과 웰빙 사회 구현에 대한 견해를 들려주세요.`,
    
    // 자연과학 계열
    '수학과': `- 수학과 AI/머신러닝의 연관성에 대해 어떻게 생각하시나요?
- 순수수학과 응용수학의 균형에 대한 견해를 들려주세요.
- 수학 교육의 디지털 전환에 대해 설명해주세요.`,
    
    '물리학과': `- 양자 컴퓨팅의 발전과 응용 가능성에 대해 어떻게 생각하시나요?
- 우주 탐사와 천체물리학의 미래에 대한 견해를 들려주세요.
- 에너지 물리학과 친환경 기술에 대해 설명해주세요.`,
    
    '화학과': `- 친환경 화학과 그린 케미스트리에 대한 견해를 들려주세요.
- 나노 화학과 신소재 개발의 미래에 대해 어떻게 생각하시나요?
- 화학과 생명과학의 융합에 대해 설명해주세요.`,
    
    '생명과학과': `- 유전자 편집 기술(CRISPR)의 윤리적 문제와 가능성에 대해 어떻게 생각하시나요?
- 바이오 기술과 의료 혁신에 대한 견해를 들려주세요.
- 생태계 보전과 생물 다양성의 중요성에 대해 설명해주세요.`
  };
  
  return questionsByMajor[major] || `- ${major} 전공에 대한 관심과 동기에 대해 설명해주세요.
- 해당 분야의 최신 동향이나 트렌드에 대해 어떻게 생각하시나요?
- 이 전공을 통해 이루고 싶은 목표나 꿈에 대해 들려주세요.`;
}

export async function POST(request: NextRequest) {
  try {
    const { messages, major, university } = await request.json();

    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: `당신은 ${university ? university : '대학'}의 전문적인 면접관입니다. ${major ? `지원자가 지원한 전공은 "${major}"입니다.` : ''} 

면접 진행 순서:
1. 먼저 자기소개를 요구합니다
2. 자기소개 후에는 ${major ? `"${major}" 전공과 관련된 구체적인 질문` : '전공과 관련된 질문'}을 합니다:
   - 해당 전공의 핵심 과목이나 주요 연구 분야에 대한 이해도
   - 전공과 관련된 최신 기술이나 트렌드에 대한 관심
   - 해당 분야의 사회적 영향이나 미래 전망
3. ${university ? university : '대학'} 지원 동기와 해당 대학의 특성에 대한 질문
4. 지원자의 경험, 동기, 미래 계획 등에 대한 질문

전공별 맞춤 질문 예시:
${major ? getMajorSpecificQuestions(major) : ''}

말투와 스타일:
- 자연스럽고 인간적인 대화를 하세요
- 문장 길이를 다양하게 하세요 (짧은 문장과 긴 문장을 섞어서)
- "음...", "그렇군요", "아, 맞네요" 같은 자연스러운 반응을 보여주세요
- 질문할 때는 "그런데요", "혹시", "그렇다면" 같은 연결어를 사용하세요
- "~하시나요?", "~어떻게 생각하시나요?" 같은 부드러운 질문을 사용하세요
- 한 번에 하나의 질문만 하세요
- 지원자의 답변을 듣고 그에 따른 후속 질문을 하세요
- ${university ? university : '대학'}의 특성과 ${major ? major : '전공'}의 특성을 고려한 질문을 하세요
- 답변은 한국어로 해주세요
- 면접관다운 전문성과 함께 인간적인 따뜻함을 보여주세요`
          },
          ...messages
        ],
        max_tokens: 200,
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      throw new Error(`OpenAI API error: ${response.status}`);
    }

    const data = await response.json();
    const message = data.choices[0].message.content;

    return NextResponse.json({ message });
  } catch (error) {
    console.error('API 오류:', error);
    return NextResponse.json(
      { error: '서버 오류가 발생했습니다.' },
      { status: 500 }
    );
  }
} 